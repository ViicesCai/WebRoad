# Vue中的角色控制

> 根据`Vue-Element-Admin`对这个功能进行逐步拆解分析

## 角色控制

> 不同的用户可能有不同的身份：如在一个系统中有操作员与管理员之分，两者在系统中的权限不同；通常管理员能形式的权力更大，而操作员仅能在系统中对部分模块进行操作

### 具体实现

> 这里仅参照：`vue-element-admin`的示例讲解思路，不提供具体代码

#### 构建路由

> 构造用于访问的路由表

+ 默认路由：不存在权限，即所有角色都可以访问的路由
+ 动态路由：即不同的角色所能访问的路由，按照不同的用户动态生成

#### 登录逻辑

> 登录获取的一些相关信息都由：`Vuex`进行保存，调用的方法也都写在`Actions`中

1. 用户登录成功时，只获取`Token`并将服务端返回的`Token`进行缓存，用于判断是否登录
2. 利用路由钩子，在每次进行路由跳转前都判断该`Token`是否存在，否则重新登录；然后在判断是否存在用户信息（第一次登录是不存在的）不存在则调用对应的方法(`GetInfo`)，通过该`Token`向服务器请求对应的用户信息，并进行缓存
3. 此时，我们就可以通过用户信息中的`role`去调用生成路由的方法(`GenerateRouters`)
4. 并利用`router`的`addRouter`方法将动态生成的路由加入即：（默认路由 + 动态路由 = 用户可访问的路由表）

#### Actions的方法

1. 获取用户信息

   + 通过`Token`调用获取用户信息的接口，这个`Token`需要在两个地方进行保存；首先在`Vuex`进行保存，然后再保存到`Cookies`中；每次`Vuex`会先从`Cookies`取值初始化，如果仅保存在`Vuex`中则页面刷新时，该值就被清空；我们仅在用户登录时才会去请求`Token`；获取到的用户信息也做相应的储存；如果希望我们能实时响应权限控制(即：用户身份发生转变时能立刻感知)则不要将用户的`role`进行缓存，即：我们每次做路由跳转时，如果该`role`为空才会去获取用户信息；仅通过`vuex`保存时，只要页面刷新了，该数据就为，这时就会再去重新获取用户信息

2. 生成路由

   + 即通过用户的身份，在动态路由中过滤出该用户可以访问的路由；
   + 首先判断该用户的身份是否为超级管理员(自定义一个角色)，该角色默认可以访问所有的路由
   + 调用一个封装好的判断权限的方法(`hasPermission`)，该方法会将用户的角色与路由中的权限进行比较判断其是否具有该权限
   + 如果模块下还具有子模块，则还需要再进行一层判断；逻辑同上
   
3. `hasPermission`
   
   + 核心：通过比对路由元信息`meta`中的`role`是否和用户的`role`相同

> 可以根据不同的业务流程，再对具体的业务进行细化

​     

